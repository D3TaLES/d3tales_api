<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>d3tales_api.Workflows.Gaussian &mdash; D&lt;sup&gt;3&lt;/sup&gt;TaLES API 0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script docs_src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> D<sup>3</sup>TaLES API
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../D3database.html">D3database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Processors.html">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Calculators.html">Calculators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../d3tales_api.html">d3tales_api package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">D<sup>3</sup>TaLES API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">d3tales_api.Workflows.Gaussian</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for d3tales_api.Workflows.Gaussian</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">add_metaclass</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.rdMolTransforms</span> <span class="kn">import</span> <span class="n">SetDihedralDeg</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">IMolecule</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.gaussian</span> <span class="kn">import</span> <span class="n">GaussianInput</span>
<span class="kn">from</span> <span class="nn">atomate.utils.utils</span> <span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">env_chk</span>
<span class="kn">from</span> <span class="nn">fireworks</span> <span class="kn">import</span> <span class="n">FiretaskBase</span><span class="p">,</span> <span class="n">explicit_serialize</span><span class="p">,</span> <span class="n">FWAction</span>
<span class="kn">from</span> <span class="nn">d3tales_api.Workflows.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">d3tales_api.Workflows.wtuning</span> <span class="kn">import</span> <span class="n">WtuningJob</span>
<span class="kn">from</span> <span class="nn">d3tales_api.D3database.d3database</span> <span class="kn">import</span> <span class="n">D3Database</span>
<span class="kn">from</span> <span class="nn">d3tales_api.Calculators.ocelot_transform</span> <span class="kn">import</span> <span class="n">pmgmol_to_rdmol</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">cpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="k">if</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="k">else</span> <span class="mi">16</span><span class="p">]</span>
<span class="n">nprocs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="c1"># Copyright 2021, University of Kentucky</span>


<div class="viewcode-block" id="GaussianBase"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.GaussianBase">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GaussianBase</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="n">_fw_name</span> <span class="o">=</span> <span class="s2">&quot;GaussianBase&quot;</span>

<div class="viewcode-block" id="GaussianBase.setup_files"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.GaussianBase.setup_files">[docs]</a>    <span class="k">def</span> <span class="nf">setup_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">):</span>
        <span class="c1"># get parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_cmd</span> <span class="o">=</span> <span class="n">env_chk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;g16_cmd&quot;</span><span class="p">),</span> <span class="n">fw_spec</span><span class="p">)</span>
        <span class="n">name_tag</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_tag&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_tag&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="n">name_tag</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;paramset&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runfile_log</span> <span class="o">=</span> <span class="n">env_chk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runfile_log&#39;</span><span class="p">),</span> <span class="n">fw_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_already_run</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_if_already_run&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_if_already_run&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_freq</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_freq&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_freq&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_freq</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span> <span class="o">==</span> <span class="s2">&quot;opt_mol&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restricted</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restricted&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restricted&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restricted&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_nto</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_nto&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_nto&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_file_name</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaussian_file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaussian_file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;gaussian&quot;</span>

        <span class="c1"># set prefix for the file names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">name_tag</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">name_tag</span> <span class="o">+</span> <span class="n">calc_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;subtype&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">name_tag</span> <span class="o">+</span> <span class="n">calc_type</span> <span class="o">+</span> <span class="s2">&quot;_mol&quot;</span>

        <span class="c1"># get calc directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_chk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span> <span class="n">fw_spec</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calc_dir&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="c1"># get the type of gaussian optimization calculation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;coupling&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">calc_type</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span>
                                                           <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;subtype&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">calc_type</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;solv_&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">calc_type</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;subtype&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">calc_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;mol_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calc_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

        <span class="c1"># Set default files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.com&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.chk&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_fchk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.fchk&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_log</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_com</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/freq_</span><span class="si">{}</span><span class="s2">.com&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_chk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/freq_</span><span class="si">{}</span><span class="s2">.chk&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_fchk</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/freq_</span><span class="si">{}</span><span class="s2">.fchk&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_log</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/freq_</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>

        <span class="c1"># create folders</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir -p </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="GaussianBase.setup_calc"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.GaussianBase.setup_calc">[docs]</a>    <span class="k">def</span> <span class="nf">setup_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_files</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="n">calc_type</span><span class="p">)</span>
        <span class="n">name_tag</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_tag&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name_tag&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">solvent</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent&quot;</span><span class="p">,</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gs_charge</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_charge&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_charge&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_groundState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gs_spin</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_spin&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_spin&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_groundState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                                                                                        <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;spin&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="n">use_iop</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_iop&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_iop&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_iop&quot;</span><span class="p">)</span>
        <span class="n">run_from_com</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_from_com&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_from_com&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="c1"># get iop string (omega value) for the calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iop_str&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iop_str&quot;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span> <span class="ow">and</span> <span class="n">use_iop</span><span class="p">:</span>
            <span class="n">molecule_data</span> <span class="o">=</span> <span class="n">RESTAPI</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;restapi/molecules/_id=</span><span class="si">{}</span><span class="s2">/mol_characterization.omega=1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">),</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://d3tales.as.uky.edu&quot;</span><span class="p">,</span> <span class="n">return_json</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">response</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tuned_w</span> <span class="o">=</span> <span class="n">molecule_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;mol_characterization&quot;</span><span class="p">][</span><span class="s1">&#39;omega&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tuned_w</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;00000&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># get starting geometry for calculation</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">geometry_sites</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_geom&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometry</span><span class="p">),</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">run_from_com</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">GaussianInput</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">)</span><span class="o">.</span><span class="n">molecule</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geometry_sites</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_sites</span><span class="p">([</span><span class="n">Site</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">geometry_sites</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">geometry_hash</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hash&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometry</span><span class="p">),</span>
                                            <span class="n">orig_hash_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">functional</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">basis_set</span><span class="p">,</span> <span class="n">tuning_parameter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">,</span>
                                                         <span class="n">solvent</span><span class="o">=</span><span class="n">solvent</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">get_db_geom</span><span class="p">(</span><span class="n">geometry_hash</span><span class="p">)</span> <span class="ow">or</span> <span class="n">start_from_smiles</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="k">if</span> <span class="n">geometry_hash</span> <span class="k">else</span> <span class="n">start_from_smiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>

            <span class="c1"># End job if the total number of atoms is greater than 200</span>
            <span class="n">num_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_atoms</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">defuse_children</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;defuser_reason&quot;</span><span class="p">:</span> <span class="s2">&quot;The molecule has </span><span class="si">{}</span><span class="s2"> atoms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">)})</span>

        <span class="c1"># Update route parameters with omega value and pcm solvent</span>
        <span class="n">radical_electrons</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs_spin</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">radical_electrons</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># calculate spin multiplicity with Hand&#39;s rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">charge</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_charge</span>
        <span class="c1"># Update functional for unrestricted calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">functional</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;R</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">functional</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Charge: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Multiplicity: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">link0_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2">hk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">,</span> <span class="s2">&quot;%mem&quot;</span><span class="p">:</span> <span class="s2">&quot;48GB&quot;</span><span class="p">,</span> <span class="s2">&quot;%nprocshared&quot;</span><span class="p">:</span> <span class="n">nprocs</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span> <span class="ow">and</span> <span class="n">use_iop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">route_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;iop(3/107=</span><span class="si">{}</span><span class="s2">, 3/108=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">):</span> <span class="s2">&quot;&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">solvent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">route_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;SCRF&quot;</span><span class="p">:</span> <span class="s2">&quot;(PCM,Solvent=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solvent</span><span class="p">)})</span></div>

<div class="viewcode-block" id="GaussianBase.run_check"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.GaussianBase.run_check">[docs]</a>    <span class="k">def</span> <span class="nf">run_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check if this job has already run and been uploaded to the backend DB</span>
        <span class="n">_hash</span> <span class="o">=</span> <span class="n">get_hash_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">RESTAPI</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;restapi/rawdata/computation/_id=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hash</span><span class="p">),</span>
                           <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://d3tales.as.uky.edu&quot;</span><span class="p">,</span> <span class="n">return_json</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">response</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GaussianBase.post_job"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.GaussianBase.post_job">[docs]</a>    <span class="k">def</span> <span class="nf">post_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upload_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delete_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name_tag</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># Upload data to database through website</span>
        <span class="n">upload_files</span> <span class="o">=</span> <span class="n">upload_files</span> <span class="ow">or</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_fchk</span><span class="p">]</span>
        <span class="n">delete_files</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># delete_files or [self.file_chk, self.file_com, self.file_fchk, self.file_log]</span>
        <span class="n">calc_type</span> <span class="o">=</span> <span class="n">calc_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">):</span>
            <span class="n">_hash</span> <span class="o">=</span> <span class="n">get_hash_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_hash</span> <span class="o">=</span> <span class="n">_hash</span>
        <span class="n">upload_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">upload_files</span><span class="p">]</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="n">zip_files</span><span class="p">(</span><span class="n">upload_names</span><span class="p">,</span> <span class="n">zip_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.zip&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name_tag</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">:</span>
            <span class="n">submission</span> <span class="o">=</span> <span class="n">RESTAPI</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tools/upload/computation-gaussian&#39;</span><span class="p">,</span>
                                 <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://d3tales.as.uky.edu&quot;</span><span class="p">,</span> <span class="n">expected_endpoint</span><span class="o">=</span><span class="s2">&quot;tools/user_uploads&quot;</span><span class="p">,</span>
                                 <span class="n">upload_file</span><span class="o">=</span><span class="n">zip_path</span><span class="p">,</span>
                                 <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">molecule_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">calculation_type</span><span class="o">=</span><span class="n">calc_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">submission</span><span class="o">.</span><span class="n">successful</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Calculation files not successfully submitted with endpoint </span><span class="si">{}</span><span class="s2">. Response endpoint &quot;</span>
                                <span class="s2">&quot;was </span><span class="si">{}</span><span class="s2">, not </span><span class="si">{}</span><span class="s2">. </span><span class="se">\n</span><span class="s2">Submission Params: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> Zip path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">expected_endpoint</span><span class="p">,</span>
                    <span class="n">submission</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.zip successfully posted!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">name_tag</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">))</span>
        <span class="c1"># Write runfile to runfile_log so the runfile can be deleted after calculation</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runfile_log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_hash</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">))</span>
        <span class="c1"># TODO write script that checks process status, approves, and deletes run dir</span>
        <span class="c1"># Remove excess files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delete_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">delete_files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -fr </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="RunGaussianEnergy"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianEnergy">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RunGaussianEnergy</span><span class="p">(</span><span class="n">GaussianBase</span><span class="p">):</span>

<div class="viewcode-block" id="RunGaussianEnergy.run_task"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianEnergy.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">setup_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_calc</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setup_obj</span><span class="p">,</span> <span class="n">FWAction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">setup_obj</span>

        <span class="c1"># generate the input for gaussian energy run</span>
        <span class="n">gauss_inp</span> <span class="o">=</span> <span class="n">generate_gaussian_input</span><span class="p">(</span><span class="n">paramset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">gauss_inp</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">cart_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_already_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_check</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
                    <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                                 <span class="s2">&quot;gs_charge&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_charge</span><span class="p">,</span> <span class="s2">&quot;gs_spin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_spin</span><span class="p">,</span>
                                 <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hash&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">):</span> <span class="n">get_hash_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span><span class="p">),</span>
                                 <span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">})</span>

        <span class="c1"># run gaussian16</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUBMITTING GAUSSIAN  ENERGY JOB </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_cmd</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># check for normal termination of gaussian job</span>
        <span class="n">gout</span> <span class="o">=</span> <span class="n">GaussianOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">)</span>
        <span class="n">final_energy</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">final_energy</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gout</span><span class="o">.</span><span class="n">properly_terminated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span> <span class="o">+</span> <span class="s2">&quot; not terminated. calc_dir &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;formchk &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;formatted checkpoint file could not be created&quot;</span><span class="p">)</span>

            <span class="c1"># Clean up files and transfer to website processing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_job</span><span class="p">(</span><span class="n">delete_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_fchk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
            <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">,</span>
                         <span class="s2">&quot;gs_charge&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_charge</span><span class="p">,</span> <span class="s2">&quot;gs_spin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_spin</span><span class="p">,</span>
                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_eng&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">):</span> <span class="n">final_energy</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="RunGaussianOpt"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianOpt">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RunGaussianOpt</span><span class="p">(</span><span class="n">GaussianBase</span><span class="p">):</span>

<div class="viewcode-block" id="RunGaussianOpt.run_task"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianOpt.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">setup_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_calc</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setup_obj</span><span class="p">,</span> <span class="n">FWAction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">setup_obj</span>

        <span class="c1"># run gaussian optimize until normal termination is achieved. max runs is 5</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">final_structure</span><span class="p">,</span> <span class="n">final_energy</span><span class="p">,</span> <span class="n">gibbs_correction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span> <span class="ow">and</span> <span class="n">runs</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">runs</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># write input files for gaussian optimization calculation</span>
            <span class="n">gauss_inp</span> <span class="o">=</span> <span class="n">generate_gaussian_input</span><span class="p">(</span><span class="n">paramset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">gauss_inp</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">cart_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_already_run</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_check</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
                        <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                                     <span class="s2">&quot;gs_charge&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_charge</span><span class="p">,</span> <span class="s2">&quot;gs_spin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_spin</span><span class="p">,</span>
                                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hash&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">):</span> <span class="n">get_hash_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span>
                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">calc_name</span><span class="p">),</span>
                                     <span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">})</span>

            <span class="c1"># run gaussian optimization</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">)</span> <span class="ow">or</span> <span class="n">runs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUBMITTING GAUSSIAN OPT JOB </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_cmd</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">gout</span> <span class="o">=</span> <span class="n">GaussianOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">)</span>

            <span class="c1"># check for normal termination</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gout</span><span class="o">.</span><span class="n">properly_terminated</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">final_structure</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># if previous job never even finished 1 structure</span>
                    <span class="k">continue</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;formchk &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;formatted checkpoint file for opt calculation could not be created&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_freq</span><span class="p">:</span>
                <span class="n">final_structure</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">final_structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;sites&#39;</span><span class="p">]</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

            <span class="c1"># generate input for frequency calculation</span>
            <span class="n">ginp</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">to_input</span><span class="p">()</span>

            <span class="c1"># update route parameters</span>
            <span class="k">if</span> <span class="n">ginp</span><span class="o">.</span><span class="n">route_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iop(3107&quot;</span><span class="p">,</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span> <span class="o">=</span> <span class="n">ginp</span><span class="o">.</span><span class="n">route_parameters</span><span class="p">[</span><span class="s2">&quot;iop(3107&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ginp</span><span class="o">.</span><span class="n">route_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;iop(3/107=</span><span class="si">{}</span><span class="s2">, 3/108=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">):</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;Geom&quot;</span><span class="p">:</span> <span class="s2">&quot;AllCheck&quot;</span><span class="p">,</span> <span class="s2">&quot;Guess&quot;</span><span class="p">:</span> <span class="s2">&quot;TCheck&quot;</span><span class="p">,</span> <span class="s2">&quot;SCRF&quot;</span><span class="p">:</span> <span class="s2">&quot;Check&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ginp</span><span class="o">.</span><span class="n">route_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;freq&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Geom&quot;</span><span class="p">:</span> <span class="s2">&quot;AllCheck&quot;</span><span class="p">,</span> <span class="s2">&quot;Guess&quot;</span><span class="p">:</span> <span class="s2">&quot;TCheck&quot;</span><span class="p">,</span> <span class="s2">&quot;SCRF&quot;</span><span class="p">:</span> <span class="s2">&quot;Check&quot;</span><span class="p">}</span>
            <span class="n">ginp</span><span class="o">.</span><span class="n">link0_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2">hk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_chk</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%o</span><span class="s2">ldchk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">})</span>
            <span class="n">ginp</span><span class="o">.</span><span class="n">dieze_tag</span> <span class="o">=</span> <span class="s1">&#39;#P&#39;</span>
            <span class="n">ginp</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_com</span><span class="p">,</span> <span class="n">cart_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># run gaussian frequency</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_log</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_chk</span><span class="p">)</span> <span class="ow">or</span> <span class="n">runs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUBMITTING GAUSSIAN FREQUENCY JOB </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> &gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_com</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_log</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fgout</span> <span class="o">=</span> <span class="n">GaussianOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_log</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fgout</span><span class="o">.</span><span class="n">properly_terminated</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Frequency calculation failed Normal termination&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">fgout</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">perturb</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># perturb structure to find structure with no negative frequencies</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;formchk &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_chk</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;formatted checkpoint file for frequency calculation could not be created&quot;</span><span class="p">)</span>

            <span class="n">final_structure</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">final_structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()[</span><span class="s1">&#39;sites&#39;</span><span class="p">]</span>
            <span class="n">final_energy</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">final_energy</span>
            <span class="n">gibbs_correction</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">corrections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gibbs Free Energy&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Structure not converged. calc_dir &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>

        <span class="c1"># Clean up files and transfer to website processing</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_freq</span><span class="p">:</span>
            <span class="n">freq_name</span> <span class="o">=</span> <span class="s2">&quot;freq_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_job</span><span class="p">(</span><span class="n">upload_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_fchk</span><span class="p">],</span> <span class="n">calc_type</span><span class="o">=</span><span class="n">freq_name</span><span class="p">,</span>
                          <span class="n">delete_files</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_chk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_fchk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_com</span><span class="p">],</span> <span class="n">name_tag</span><span class="o">=</span><span class="s2">&quot;freq_&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_job</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
            <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;gs_charge&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_charge</span><span class="p">,</span>
                         <span class="s2">&quot;gs_spin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_spin</span><span class="p">,</span>
                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hash&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_hash</span><span class="p">,</span>
                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_geom&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">):</span> <span class="n">final_structure</span><span class="p">,</span>
                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_eng&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">):</span> <span class="n">final_energy</span><span class="p">,</span>
                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_gibb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">):</span> <span class="n">gibbs_correction</span><span class="p">,</span>
                         <span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;iop_str&#39;</span><span class="p">)})</span></div></div>


<div class="viewcode-block" id="RunWtuning"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunWtuning">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RunWtuning</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>

<div class="viewcode-block" id="RunWtuning.run_task"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunWtuning.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1"># get parameters</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">env_chk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span> <span class="n">fw_spec</span><span class="p">)</span>
        <span class="n">runfile_log</span> <span class="o">=</span> <span class="n">env_chk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runfile_log&#39;</span><span class="p">),</span> <span class="n">fw_spec</span><span class="p">)</span>
        <span class="n">paramset</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;paramset&quot;</span><span class="p">]</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
        <span class="n">gs_charge</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_charge&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_charge&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_groundState</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
        <span class="n">gs_spin</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_spin&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gs_spin&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_groundState</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;spin&#39;</span><span class="p">)</span>
        <span class="n">gaussian_file_name</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaussian_file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaussian_file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;gaussian&quot;</span>
        <span class="n">calc_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">gaussian_file_name</span><span class="p">)</span>
        <span class="n">check_if_already_run</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_if_already_run&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;check_if_already_run&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>
        <span class="n">submit</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">True</span>
        <span class="n">restricted</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restricted&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restricted&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restricted&quot;</span><span class="p">)</span>

        <span class="n">radical_electrons</span> <span class="o">=</span> <span class="p">(</span><span class="n">gs_spin</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">paramset</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">paramset</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">radical_electrons</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># calculate spin multiplicity with Hand&#39;s rule</span>
        <span class="n">paramset</span><span class="o">.</span><span class="n">charge</span> <span class="o">+=</span> <span class="n">gs_charge</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">paramset</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">paramset</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">)</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">geometry_sites</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_geom&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometry</span><span class="p">),</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry_sites</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_sites</span><span class="p">([</span><span class="n">Site</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="k">for</span> <span class="n">sd</span> <span class="ow">in</span> <span class="n">geometry_sites</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geometry_hash</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_hash&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometry</span><span class="p">),</span> <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">get_db_geom</span><span class="p">(</span><span class="n">geometry_hash</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">start_from_smiles</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

        <span class="c1"># create folder</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">,</span> <span class="s2">&quot;wtuning&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir -p </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">working_dir</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="n">gauss_inp</span> <span class="o">=</span> <span class="n">generate_gaussian_input</span><span class="p">(</span><span class="n">paramset</span><span class="o">=</span><span class="n">paramset</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">gauss_inp</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="s1">&#39;wtuning.com&#39;</span><span class="p">,</span> <span class="n">cart_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># check if job has already run</span>
        <span class="k">if</span> <span class="n">check_if_already_run</span><span class="p">:</span>
            <span class="n">init_query</span> <span class="o">=</span> <span class="n">RESTAPI</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span>
                                 <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;restapi/molecules/_id=</span><span class="si">{}</span><span class="s2">/mol_characterization.omega=1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">),</span>
                                 <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://d3tales.as.uky.edu&quot;</span><span class="p">,</span> <span class="n">return_json</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">response</span>
            <span class="k">if</span> <span class="n">init_query</span><span class="p">:</span>
                <span class="n">omega_dict_list</span> <span class="o">=</span> <span class="n">init_query</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mol_characterization&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;omega&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">omega_dict_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">tuned_w</span> <span class="o">=</span> <span class="n">omega_dict_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
                    <span class="n">iop_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tuned_w</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;00000&quot;</span>
                    <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
                        <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="n">iop_str</span><span class="p">,</span> <span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="n">calc_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">identifier</span><span class="p">,</span>
                                     <span class="s2">&quot;gs_charge&quot;</span><span class="p">:</span> <span class="n">gs_charge</span><span class="p">,</span> <span class="s2">&quot;gs_spin&quot;</span><span class="p">:</span> <span class="n">gs_spin</span><span class="p">})</span>

        <span class="c1"># generate the input for wtuning in gaussian and run tuning</span>
        <span class="n">functional</span> <span class="o">=</span> <span class="n">paramset</span><span class="o">.</span><span class="n">functional</span> <span class="k">if</span> <span class="n">restricted</span> <span class="k">else</span> <span class="s2">&quot;R</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramset</span><span class="o">.</span><span class="n">functional</span><span class="p">)</span>
        <span class="n">wt_mol</span> <span class="o">=</span> <span class="n">WtuningJob</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">functional</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">paramset</span><span class="o">.</span><span class="n">basis_set</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;wtuning&quot;</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
                            <span class="n">n_charge</span><span class="o">=</span><span class="n">paramset</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">n_spin</span><span class="o">=</span><span class="n">paramset</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">wdir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;Jh&#39;</span><span class="p">,</span> <span class="n">wbmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                            <span class="n">wbmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">wt_mol</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
        <span class="n">wt_mol</span><span class="o">.</span><span class="n">wtuning_cycle</span><span class="p">(</span><span class="n">max_cycles</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># get the tuned w value from the run</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;output.log&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">tuned_w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">iop_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tuned_w</span> <span class="o">*</span> <span class="mf">1e4</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;00000&quot;</span>

        <span class="c1"># Upload data to database through website</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wtuning.com&#39;</span><span class="p">,</span> <span class="s1">&#39;output.log&#39;</span><span class="p">]</span>
        <span class="n">zip_name</span> <span class="o">=</span> <span class="n">zip_files</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">zip_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_wtuning.zip&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">identifier</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">submit</span><span class="p">:</span>
            <span class="n">submission</span> <span class="o">=</span> <span class="n">RESTAPI</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;tools/upload/computation-gaussian&#39;</span><span class="p">,</span>
                                 <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://d3tales.as.uky.edu&quot;</span><span class="p">,</span> <span class="n">expected_endpoint</span><span class="o">=</span><span class="s2">&quot;tools/user_uploads&quot;</span><span class="p">,</span>
                                 <span class="n">upload_file</span><span class="o">=</span><span class="n">zip_name</span><span class="p">,</span>
                                 <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">molecule_id</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">calculation_type</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">submission</span><span class="o">.</span><span class="n">successful</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Calculation files not successfully submitted with endpoint </span><span class="si">{}</span><span class="s2">. Responce endpoint &quot;</span>
                                <span class="s2">&quot;was </span><span class="si">{}</span><span class="s2">, not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                                                        <span class="n">submission</span><span class="o">.</span><span class="n">expected_endpoint</span><span class="p">))</span>
        <span class="n">data_hash</span> <span class="o">=</span> <span class="n">get_hash_id</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="s1">&#39;wtuning.com&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;output.log&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">runfile_log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_hash</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf *.chk *.fchk tuning_wtuning_ocycle*&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
            <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="n">iop_str</span><span class="p">,</span> <span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="n">calc_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;gs_charge&quot;</span><span class="p">:</span> <span class="n">gs_charge</span><span class="p">,</span>
                         <span class="s2">&quot;gs_spin&quot;</span><span class="p">:</span> <span class="n">gs_spin</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="RunGaussianTDDFT"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianTDDFT">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RunGaussianTDDFT</span><span class="p">(</span><span class="n">GaussianBase</span><span class="p">):</span>

    <span class="c1"># Does not yet have solvent capability</span>
<div class="viewcode-block" id="RunGaussianTDDFT.run_task"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianTDDFT.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">setup_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_calc</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setup_obj</span><span class="p">,</span> <span class="n">FWAction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">setup_obj</span>

        <span class="c1"># generate the input for gaussian energy run</span>
        <span class="n">gauss_inp</span> <span class="o">=</span> <span class="n">generate_gaussian_input</span><span class="p">(</span><span class="n">paramset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">gauss_inp</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">cart_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_already_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_check</span><span class="p">()</span>

        <span class="c1"># run gaussian16</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUBMITTING GAUSSIAN TDDFT JOB </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_cmd</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># check for normal termination of gaussian job</span>
        <span class="n">gout</span> <span class="o">=</span> <span class="n">GaussianOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gout</span><span class="o">.</span><span class="n">properly_terminated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span> <span class="o">+</span> <span class="s2">&quot; not terminated. calc_dir &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;formchk &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;TDDFT calculation formatted checkpoint file could not be created&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_nto</span><span class="p">:</span>
                <span class="n">nto_com</span><span class="p">,</span> <span class="n">nto_chk</span> <span class="o">=</span> <span class="n">write_nto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tddft_chk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">)</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_cmd</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">nto_com</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">nto_gout</span> <span class="o">=</span> <span class="n">GaussianOutput</span><span class="p">(</span><span class="n">nto_com</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.com&quot;</span><span class="p">,</span> <span class="s2">&quot;.log&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nto_gout</span><span class="o">.</span><span class="n">properly_terminated</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">nto_com</span> <span class="o">+</span> <span class="s2">&quot; not terminated. calc_dir &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
                <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;formchk &quot;</span> <span class="o">+</span> <span class="n">nto_chk</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;NTO analysis formatted checkpoint file could not be created&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">post_job</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
            <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">,</span>
                         <span class="s2">&quot;gs_charge&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_charge</span><span class="p">,</span> <span class="s2">&quot;gs_spin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gs_spin</span><span class="p">})</span></div></div>


<span class="c1"># RETIRED CLASS. This class needs the OCELOT API to be installed.</span>

<span class="c1"># @explicit_serialize</span>
<span class="c1"># class GetLowestEConformer(GaussianBase):</span>
<span class="c1">#</span>
<span class="c1">#     def run_task(self, fw_spec):</span>
<span class="c1">#         self[&quot;use_iop&quot;] = False</span>
<span class="c1">#         self.setup_files(fw_spec, calc_type=&#39;conformations&#39;)</span>
<span class="c1">#         smiles = fw_spec.get(&quot;smiles&quot;, ) or self[&quot;smiles&quot;]</span>
<span class="c1">#         mol = Chem.MolFromSmiles(smiles)</span>
<span class="c1">#         molH = AllChem.AddHs(mol)</span>
<span class="c1">#         c = ConfGen(m=molH, mol_name=self.identifier, prune_in_gen=0.5)</span>
<span class="c1">#         c.genconfs(write_confs=True)</span>
<span class="c1">#         structures, energies = {}, {}</span>
<span class="c1">#         for f in [f for f in os.listdir(os.getcwd()) if f.endswith(&#39;.xyz&#39;)]:</span>
<span class="c1">#             self[&quot;prefix&quot;] = f.strip(&#39;.xyz&#39;)</span>
<span class="c1">#             self.setup_files(fw_spec, calc_type=&#39;conformations&#39;)</span>
<span class="c1">#             self.paramset.link0_parameters.update({&quot;%chk&quot;: self.file_chk, &quot;%mem&quot;: &quot;48GB&quot;, &quot;%nprocshared&quot;: nprocs})</span>
<span class="c1">#             self.paramset.basis_set = &#39; &#39;</span>
<span class="c1">#             mol = Molecule.from_file(f)</span>
<span class="c1">#             gauss_inp = generate_gaussian_input(paramset=self.paramset, mol=mol, dieze_tag=&quot;#&quot;)</span>
<span class="c1">#             gauss_inp.write_file(self.file_com, cart_coords=True)</span>
<span class="c1">#             print(&#39;SUBMITTING GAUSSIAN  ENERGY JOB {} for {}&#39;.format(self.full_name, self.identifier))</span>
<span class="c1">#             subprocess.call(self.gaussian_cmd + &quot; &quot; + self.file_com, shell=True)</span>
<span class="c1">#</span>
<span class="c1">#             # check for normal termination of gaussian job</span>
<span class="c1">#             gout = GaussianOutput(self.file_log)</span>
<span class="c1">#             if not gout.properly_terminated:</span>
<span class="c1">#                 continue</span>
<span class="c1">#             try:</span>
<span class="c1">#                 energies[f] = gout.final_energy</span>
<span class="c1">#             except:</span>
<span class="c1">#                 energies[f] = get_scfs(self.file_log)[-1]</span>
<span class="c1">#             structures[f] = gout.final_structure.as_dict()[&#39;sites&#39;]</span>
<span class="c1">#</span>
<span class="c1">#         lowest_e_conf = max(energies, key=energies.get)</span>
<span class="c1">#         mol = Molecule.from_file(lowest_e_conf)</span>
<span class="c1">#         conformer = structures[f]</span>
<span class="c1">#         for file in [self.file_chk, self.file_com]:</span>
<span class="c1">#             os.system(&quot;rm -fr {}&quot;.format(file))</span>
<span class="c1">#         return FWAction(</span>
<span class="c1">#             update_spec={&quot;identifier&quot;: self.identifier, &quot;conformer_geom&quot;: conformer, &quot;energy_dict&quot;: energies})</span>


<div class="viewcode-block" id="RunGaussianDihedRot"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianDihedRot">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RunGaussianDihedRot</span><span class="p">(</span><span class="n">GaussianBase</span><span class="p">):</span>

<div class="viewcode-block" id="RunGaussianDihedRot.run_task"><a class="viewcode-back" href="../../../d3tales_api.Workflows.html#d3tales_api.Workflows.Gaussian.RunGaussianDihedRot.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">setup_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_calc</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">calc_type</span><span class="o">=</span><span class="s1">&#39;dihedrot&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">setup_obj</span><span class="p">,</span> <span class="n">FWAction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">setup_obj</span>

        <span class="c1"># Get dihedral angle atoms to be rotated and frozen</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;dihed_degree&#39;</span><span class="p">]</span>
        <span class="n">rdk_mol</span> <span class="o">=</span> <span class="n">pmgmol_to_rdmol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dihed_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">get_central_dihed</span><span class="p">(</span><span class="n">rdk_mol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># Set dihedral angle</span>
        <span class="n">rotated_mol</span> <span class="o">=</span> <span class="n">SetDihedralDeg</span><span class="p">(</span><span class="n">rdk_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(),</span> <span class="o">*</span><span class="n">dihed_idxs</span><span class="p">,</span> <span class="n">degree</span><span class="p">)</span>

        <span class="c1"># generate the input for gaussian energy run</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">rdmolfiles</span><span class="o">.</span><span class="n">MolToXYZBlock</span><span class="p">(</span><span class="n">rotated_mol</span><span class="p">)</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="o">.</span><span class="n">route_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;opt&quot;</span><span class="p">:</span> <span class="s2">&quot;modredundant&quot;</span><span class="p">,</span> <span class="s1">&#39;SCF&#39;</span><span class="p">:</span> <span class="s1">&#39;(MaxCycle=512)&#39;</span><span class="p">,</span> <span class="s1">&#39;Int&#39;</span><span class="p">:</span> <span class="s1">&#39;(Grid=SuperFine)&#39;</span><span class="p">})</span>
        <span class="n">gauss_inp</span> <span class="o">=</span> <span class="n">generate_gaussian_input</span><span class="p">(</span><span class="n">paramset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paramset</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">gauss_inp</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">cart_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Freeze dihedral angle in com file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">com</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;D </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> =</span><span class="si">{}</span><span class="s2"> B</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">degree</span><span class="p">))</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;D </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> F</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dihed_idxs</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">com</span><span class="p">:</span>
            <span class="n">com</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="c1"># run gaussian16</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUBMITTING GAUSSIAN DIHED ROT JOB </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">degree</span><span class="p">))</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_cmd</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># check for normal termination of gaussian job</span>
        <span class="n">gout</span> <span class="o">=</span> <span class="n">GaussianOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gout</span><span class="o">.</span><span class="n">properly_terminated</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_com</span> <span class="o">+</span> <span class="s2">&quot; not terminated. calc_dir &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;formchk </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_fchk</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;formatted checkpoint file could not be created&quot;</span><span class="p">)</span>

            <span class="c1"># Insert into database</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="n">runtime_from_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">)</span>
            <span class="n">pmgmol</span> <span class="o">=</span> <span class="n">IMolecule</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">)</span>
            <span class="n">mol_xyz</span> <span class="o">=</span> <span class="n">pmgmol</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span><span class="p">)</span>

            <span class="n">num_electrons</span> <span class="o">=</span> <span class="n">gout</span><span class="o">.</span><span class="n">electrons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eigens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gout</span><span class="o">.</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">homo</span> <span class="o">=</span> <span class="n">eigens</span><span class="p">[</span><span class="n">num_electrons</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">27.2114</span>
            <span class="n">lumo</span> <span class="o">=</span> <span class="n">eigens</span><span class="p">[</span><span class="n">num_electrons</span><span class="p">]</span> <span class="o">*</span> <span class="mf">27.2114</span>
            <span class="c1"># energy = out_mol.final_energy * 27.2114</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gout</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span> <span class="o">*</span> <span class="mf">27.2114</span>
            <span class="n">backbone_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">pmgmol</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">)</span>
            <span class="n">insert_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># Polymer data</span>
                <span class="s2">&quot;molecule_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mol_name&#39;</span><span class="p">),</span>
                <span class="s2">&quot;tuned_omega&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">,</span>
                <span class="c1"># Rotation dictionaries</span>
                <span class="s2">&quot;structures&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span> <span class="n">mol_xyz</span><span class="p">},</span>
                <span class="s2">&quot;energies&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span> <span class="n">energy</span><span class="p">},</span>
                <span class="s2">&quot;homos&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span> <span class="n">homo</span><span class="p">},</span>
                <span class="s2">&quot;lumos&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span> <span class="n">lumo</span><span class="p">},</span>
                <span class="s2">&quot;runtimes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span> <span class="n">runtime</span><span class="p">},</span>
                <span class="s2">&quot;backbone_length&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span> <span class="n">backbone_len</span><span class="p">}</span>
            <span class="p">}</span>
            <span class="n">D3Database</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="s2">&quot;dihed_rot&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">insert_data</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
                                                                                                    <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Clean up files</span>
            <span class="n">delete_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_log</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_fchk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_com</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">delete_files</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -fr </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span>
            <span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gaussrun_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="s2">&quot;iop_str&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iop_str</span><span class="p">})</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, University of Kentucky.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>